<!DOCTYPE html>
<html>
<head>
    <title>{{ section_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        async function toggleEntity(entity_id, btn) {
            btn.disabled = true;
            const res = await fetch(`/toggle/${entity_id}`);
            if(res.ok){
                const currentClass = btn.classList.contains("btn-warning") ? "btn-warning" : "btn-secondary";
                btn.classList.toggle("btn-warning");
                btn.classList.toggle("btn-secondary");
                const name = btn.getAttribute("data-name");
                btn.innerText = btn.classList.contains("btn-warning") ? `${name} - ON` : `${name} - OFF`;
            }
            btn.disabled = false;
        }

        async function refreshEntities() {
            const section_name = "{{ section_name }}";
            const res = await fetch(`/entities_status/${section_name}`);
            if(res.ok){
                const data = await res.json();
                data.forEach(ent => {
                    const btn = document.getElementById(ent.entity_id);
                    if(btn){
                        const name = btn.getAttribute("data-name");
                        if(ent.state == "on" || ent.state=="open" || ent.state=="unlocked"){
                            btn.classList.add("btn-warning");
                            btn.classList.remove("btn-secondary");
                            btn.innerText = `${name} - ON`;
                        } else {
                            btn.classList.add("btn-secondary");
                            btn.classList.remove("btn-warning");
                            btn.innerText = `${name} - OFF`;
                        }
                    }
                });
            }
        }

        setInterval(refreshEntities, 5000);
    </script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between mb-3">
            <h1>{{ section_name }}</h1>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back</a>
        </div>
       <div class="row g-3">
    {% for ent in entities %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            {% if ent.entity_id.startswith('camera.') %}
                <!-- بطاقة الكاميرا -->
                <div class="card">
                    <video controls autoplay muted class="card-img-top">
                        <source src="{{ session['ha_url'] }}/api/camera_proxy_stream/{{ ent.entity_id }}?token={{ session['ha_token'] }}" type="video/mp4">
                    </video>
                    <div class="card-body text-center">
                        <h5 class="card-title">{{ ent.name }}</h5>
                    </div>
                </div>
            {% elif ent.entity_id.startswith('script.') %}
                <!-- زر سكربت -->
                <button class="btn btn-success w-100 mb-2" data-name="{{ ent.name }}" onclick="runScript('{{ ent.entity_id }}', this)">
                    {{ ent.name }}
                </button>
            {% else %}
                <!-- زر toggle -->
                <button class="btn {% if ent.state in ['on','open','unlocked'] %}btn-warning{% else %}btn-secondary{% endif %} w-100 mb-2" 
                        data-name="{{ ent.name }}" id="{{ ent.entity_id }}"
                        onclick="toggleEntity('{{ ent.entity_id }}', this)">
                    {{ ent.name }} - {% if ent.state in ['on','open','unlocked'] %}ON{% else %}OFF{% endif %}
                </button>
            {% endif %}
        </div>
    {% endfor %}
</div>

    </div>
</body>
</html>
