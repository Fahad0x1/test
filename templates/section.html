<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>{{ section_name }}</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script>
async function toggleEntity(entity_id, btn) {
    btn.disabled = true;
    const res = await fetch(`/toggle/${entity_id}`);
    if(res.ok){
        const name = btn.getAttribute("data-name");
        btn.classList.toggle("btn-warning");
        btn.classList.toggle("btn-secondary");
        btn.innerText = btn.classList.contains("btn-warning") ? `${name} - ON` : `${name} - OFF`;
    }
    btn.disabled = false;
}

async function refreshEntities() {
    const section_name = "{{ section_name }}";
    const res = await fetch(`/entities_status/${section_name}`);
    if(res.ok){
        const data = await res.json();
        data.forEach(ent => {
            const btn = document.getElementById(ent.entity_id);
            if(btn){
                const name = btn.getAttribute("data-name");
                if(ent.state == "on" || ent.state=="open" || ent.state=="unlocked"){
                    btn.classList.add("btn-warning");
                    btn.classList.remove("btn-secondary");
                    btn.innerText = `${name} - ON`;
                } else {
                    btn.classList.add("btn-secondary");
                    btn.classList.remove("btn-warning");
                    btn.innerText = `${name} - OFF`;
                }
            }
        });
    }
}
setInterval(refreshEntities, 5000);
</script>

<style>
  body { background:#f8f9fa; }
  .entity-btn { padding:1rem; font-size:1.2rem; margin-bottom:1rem; width:100%; border-radius:0.5rem; }
  video { width:100%; border-radius:10px; margin-bottom:1rem; }
</style>
</head>
<body>
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ section_name }}</h2>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Back</a>
    </div>

    <div class="row g-3 justify-content-center">
    {% for ent in entities %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex justify-content-center">
            {% if ent.entity_id.startswith('camera.') %}
            <video controls autoplay muted>
                <source src="{{ session['ha_url'] }}/api/camera_proxy_stream/{{ ent.entity_id }}?token={{ session['ha_token'] }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <p class="text-center">{{ ent.name }}</p>
            {% else %}
            <button id="{{ ent.entity_id }}"
                    data-name="{{ ent.name }}"
                    class="btn entity-btn {% if ent.state == 'on' or ent.state=='open' or ent.state=='unlocked' %}btn-warning{% else %}btn-secondary{% endif %}"
                    onclick="toggleEntity('{{ ent.entity_id }}', this)">
                {{ ent.name }} - {% if ent.state == 'on' or ent.state=='open' or ent.state=='unlocked' %}ON{% else %}OFF{% endif %}
            </button>
            {% endif %}
        </div>
    {% endfor %}
    </div>
</div>
</body>
</html>
